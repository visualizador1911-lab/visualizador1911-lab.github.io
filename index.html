<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FORMATEAR TEXTO SHOTSPOTTER</title>
<style>
html, body, * { cursor: url("./CURSOR.cur"), auto; }
body { background-color: #1A0E3D; color: #E6E6FA; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
h2 { color: #7FFF00; text-align: center; font-size: 2em; }
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
#title span { display: inline-block; animation: float 2s ease-in-out infinite; }
textarea { width: 100%; max-width: 100%; background-color: #2E1A5C; color: #E6E6FA; border: 2px solid #7FFF00; padding: 10px; font-family: monospace; font-size: 14px; resize: vertical; box-sizing: border-box; }
button { background-color: #7FFF00; color: #1A0E3D; border: none; padding: 10px 20px; margin: 5px 5px 15px 0; font-weight: bold; cursor: pointer; transition: 0.2s; }
button:hover { background-color: #5FCC00; }
#output { background-color: #2E1A5C; color: #E6E6FA; border: 2px solid #7FFF00; width: 100%; max-width: 100%; }
#counter { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 1.5em; font-weight: bold; text-transform: uppercase; margin: 10px 0 10px 0; color: #FF8C00; text-shadow: 0 0 6px #FF8C00, 0 0 12px #FF6600; }
#log { margin-top: 10px; max-height: 250px; overflow-y: auto; border: 2px solid #7FFF00; padding: 10px; background-color: #1F0F4B; font-family: monospace; white-space: pre; }
.log-entry { padding: 5px; border-bottom: 1px solid #7FFF00; }
.timestamp { color: #AAAAAA; margin-right: 10px; user-select: none; }
.log-content { user-select: text; color: #E6E6FA; }
#warning { position: fixed; top: 20px; right: 20px; background: #FF3333; color: white; padding: 12px 18px; border-radius: 6px; font-weight: bold; box-shadow: 0 0 10px #000; opacity: 0; transition: opacity .4s ease; z-index: 9999; }
#warning.show { opacity: 1; }
#pasteHint { margin-top: 12px; font-size: 1.2em; color: rgba(127, 255, 0, 0.75); font-weight: bold; text-align: center; text-shadow: 0 0 6px rgba(127, 255, 0, 0.8), 0 0 12px rgba(95, 204, 0, 0.8); }
@media (max-width: 768px) { textarea { font-size: 12px; } button { padding: 8px 12px; font-size: 12px; } }

/* ROUNDS ANIMATION */
#roundsAnimationContainer {
    position: fixed;
    bottom: 20px;
    left: 20px;
    max-width: 90%;
    z-index: 9999;
    pointer-events: none;
    display: flex;
    align-items: center;
    gap: 10px;
}

.rounds-line {
    display: flex;
    align-items: center;
    gap: 6px;
}

.rounds-text {
    font-size: 1.4em;
    font-weight: bold;
    color: #FF5555;
    text-shadow: 0 0 6px red;
}

.rounds-bullet {
    width: 32px;
    height: 32px;
    opacity: 0;
    transform: scale(0.5);
    transition: opacity 0.15s ease, transform 0.15s ease;
}

/* Special image style (Polaroid-style) */
.rounds-special {
    width: 150px;
    height: auto;
    opacity: 0;
    transform: scale(0.5);
    transition: opacity 0.5s ease, transform 0.5s ease, filter 0.3s ease;
    border: 4px solid white;
    box-shadow: 0 0 20px #fff;
    border-radius: 8px;
}

#zonaLabel {
    font-size: 1.5em;
    font-weight: bold;
    color: #7FFF00;
    margin-right: 10px;
}
</style>
</head>
<body>

<h2 id="title">FORMATEAR TEXTO SHOTSPOTTER</h2>

<textarea id="input" rows="12" placeholder="Pegar acá el incidente"></textarea>
<br>
<button onclick="convertir()">Convertir</button>
<button onclick="limpiar()">Limpiar</button>
<button onclick="clearLog()">Limpiar Historial</button>
<button onclick="downloadLogCSV()">Exportar a CSV</button>
<br><br>
<textarea id="output" rows="2" placeholder="Resultado aquí..." readonly></textarea>

<div id="counter">CANTIDAD DE EVENTOS CARGADOS: 0</div>

<div id="log"><strong>Historial de conversiones:</strong></div>
<div id="pasteHint">Pegar en planilla utilizando Control+Shift+V</div>
<div id="warning"></div>

<!-- Rounds animation container -->
<div id="roundsAnimationContainer"></div>

<script>
const input = document.getElementById("input");
const output = document.getElementById("output");
const log = document.getElementById("log");
const counter = document.getElementById("counter");

let sixthLine = "";

// Heatmap-style rounds color
function roundsToColor(rounds) {
    let n = parseInt(rounds);
    if (isNaN(n)) return "color:#E6E6FA;";
    if (n <= 2) return "color:#E6E6FA;";

    let t = Math.min(Math.max((n - 3) / 7, 0), 1);
    let r, g, b;
    if (t < 0.5) {
        let k = t / 0.5;
        r = 255;
        g = Math.floor(255 - 127 * k);
        b = 0;
    } else {
        let k = (t - 0.5) / 0.5;
        r = 255;
        g = Math.floor(128 - 128 * k);
        b = 0;
    }
    return `color: rgb(${r},${g},${b});`;
}

// Rounds animation with Zona image staying until bullets finish
function animateRounds(rounds) {
    rounds = parseInt(rounds);
    if (!rounds || rounds <= 0) return;

    const container = document.getElementById("roundsAnimationContainer");
    container.innerHTML = "";

    const line = document.createElement("div");
    line.className = "rounds-line";

    // Zona label
    const zonaLabel = document.createElement("span");
    zonaLabel.id = "zonaLabel";
    zonaLabel.textContent = "Zona:";
    line.appendChild(zonaLabel);

    // Determine special image based on sixthLine
    let specialImgSrc = "";
    if (sixthLine === "UYMontevideoCerro") specialImgSrc = "./cerro.png";
    else if (sixthLine === "UYMontevideoLasAcacias") specialImgSrc = "./acacias.png";
    else if (sixthLine === "UYMontevideoPenarol") specialImgSrc = "./penarol.png";

    // Add Zona image if exists
    let bulletsDelay = 0;
    let specialImg = null;
    if (specialImgSrc) {
        specialImg = document.createElement("img");
        specialImg.src = specialImgSrc;
        specialImg.className = "rounds-special";
        specialImg.style.opacity = "0";
        specialImg.style.transform = "scale(0.5)";
        line.appendChild(specialImg);

        // Polaroid flash: scale up + bright
        setTimeout(() => {
            specialImg.style.opacity = "1";
            specialImg.style.transform = "scale(1.2)";
            specialImg.style.filter = "brightness(300%)";
        }, 0);

        // Return to normal size & brightness
        setTimeout(() => {
            specialImg.style.transform = "scale(1)";
            specialImg.style.filter = "brightness(100%)";
        }, 300);

        bulletsDelay = 350; // start bullets after flash
    }

    // Rondas label
    const roundsLabel = document.createElement("span");
    roundsLabel.className = "rounds-text";
    roundsLabel.textContent = `Rondas × ${rounds}`;
    roundsLabel.style.opacity = "0";
    setTimeout(() => { roundsLabel.style.opacity = "1"; }, bulletsDelay);
    line.appendChild(roundsLabel);

    // Show bullets one by one
    for (let i = 0; i < rounds; i++) {
        const img = document.createElement("img");
        img.src = "./balita.png";
        img.className = "rounds-bullet";
        line.appendChild(img);

        setTimeout(() => {
            img.style.opacity = "1";
            img.style.transform = "scale(1)";
        }, i * 120 + bulletsDelay);
    }

    container.appendChild(line);

    // Remove everything after all bullets appear
    const totalDuration = bulletsDelay + rounds * 120 + 800;
    setTimeout(() => { container.innerHTML = ""; }, totalDuration);
}

// Helper functions
function updateCounter() {
    counter.textContent = "CANTIDAD DE EVENTOS CARGADOS: " + document.querySelectorAll(".log-entry").length;
}
function showWarning(msg) {
    const w = document.getElementById("warning");
    w.textContent = msg;
    w.classList.add("show");
    setTimeout(() => w.classList.remove("show"), 2500);
}
input.addEventListener("paste", function() {
    input.value = "";
    setTimeout(() => { convertir(); }, 0);
});

// Main conversion
function convertir() {
    if (!input.value.trim()) return;
    let lines = input.value.split("\n").map(l => l.trim());

    let line1 = lines[0] || "";
    let line2 = lines[2] || "";
    let line3 = lines[3] || "";
    let line5, line6, line7, sivve = "";

    if (lines.length === 8) {
        line5 = lines[4] || "";
        line6 = lines[5] || "";
        line7 = lines[6] || "";
    } else if (lines.length === 9) {
        line5 = lines[5] || "";
        line6 = lines[6] || "";
        line7 = lines[7] || "";
        let lineWithCAD = lines[4] || ""; 
        const sivveMatch = lineWithCAD.match(/CAD\s*ID\s*(\d{8})/i);
        sivve = sivveMatch ? sivveMatch[1] : "";
    }

    sixthLine = line6; // store sixthLine globally

    let id = (line3.match(/ID\s*([A-Za-z0-9-]+)/i) || [])[1] || "";
    let dateTime = ((line2.match(/(\d{2}\/\d{2}\/\d{4})\s*@\s*(\d{2}:\d{2}:\d{2})/) || []).slice(1).join(" ")) || "";
    let address = (line1.match(/(?:en|at)\s+(.*)/i) || [])[1] || line1;
    let round = (line1.match(/^(\d+)/) || [])[1] || "";

    let beat = "";
    let beatSectorMatch = line5.match(/\b(Beat|Sector)\b[:\s]*(.*)$/iu);
    if (beatSectorMatch) beat = beatSectorMatch[2].trim();

    let lat = "", lon = "";
    const coordMatch = line7.match(/(-?\d+(?:,\d+)*)\s*,\s*(-?\d+(?:,\d+)*)/);
    if (coordMatch) { lat = coordMatch[1].replace(/,/g, "."); lon = coordMatch[2].replace(/,/g, "."); }

    let missing = [];
    if (!id) missing.push("ID");
    if (!dateTime) missing.push("Fecha/Hora");
    if (!address) missing.push("Dirección");
    if (!lat) missing.push("Latitud (X)");
    if (!lon) missing.push("Longitud (Y)");
    if (missing.length > 0) {
        showWarning("❗ Campos faltantes: " + missing.join(", "));
        return;
    }

    let resultArray = [id, dateTime, "", sixthLine, address, round, beat, lat, lon, "", "", sivve || ""];
    let result = resultArray.join("\t");
    output.value = result;

    animateRounds(round);

    const existing = [...document.querySelectorAll(".log-entry .log-content")].map(e => e.textContent);
    if (existing.includes(result)) { showWarning("⚠ Este evento ya está en el historial."); return; }

    const time = new Date().toLocaleString();
    const entry = document.createElement("div");
    entry.className = "log-entry";

    const tsSpan = document.createElement("span");
    tsSpan.className = "timestamp";
    tsSpan.textContent = `[${time}]`;

    const contentSpan = document.createElement("span");
    contentSpan.className = "log-content";

    const fields = result.split("\t");
    const roundsValue = fields[5];

    fields[5] = `<span style="${roundsToColor(roundsValue)} ${roundsValue >= 10 ? 'font-weight:bold;' : ''}">${roundsValue}</span>`;
    contentSpan.innerHTML = fields.join("\t");

    entry.appendChild(tsSpan);
    entry.appendChild(contentSpan);

    const entries = [...document.querySelectorAll(".log-entry")];
    let inserted = false;
    const newDate = dateTimeToObj(resultArray[1]);

    for (let existingEntry of entries) {
        const existingText = existingEntry.querySelector(".log-content").textContent;
        const existingDateTimeStr = existingText.split("\t")[1];
        const existingDate = dateTimeToObj(existingDateTimeStr);
        if (newDate < existingDate) { 
            log.insertBefore(entry, existingEntry); 
            inserted = true; 
            break; 
        }
    }
    if (!inserted) log.appendChild(entry);

    updateCounter();
    output.focus(); 
    output.select();
}

function dateTimeToObj(dateTimeStr) {
    const [date, time] = dateTimeStr.split(" ");
    const [d, m, y] = date.split("/").map(Number);
    const [hh, mm, ss] = time.split(":").map(Number);
    return new Date(y, m - 1, d, hh, mm, ss);
}

function limpiar() { input.value = ""; output.value = ""; input.focus(); }
function clearLog() { log.innerHTML = "<strong>Historial de conversiones:</strong>"; updateCounter(); }

function downloadLogCSV() {
    let logContents = document.querySelectorAll(".log-entry .log-content");
    if (logContents.length === 0) { showWarning("⚠ No hay datos en el historial."); return; }

    let rows = [];
    logContents.forEach(entry => {
        const fields = entry.textContent.split("\t");
        const escaped = fields.map(f => `"${f.replace(/"/g, '""')}"`);
        rows.push(escaped.join(","));
    });

    const firstLog = logContents[0].textContent;
    let logDate = "sinfecha";
    const parts = firstLog.split("\t");
    if (parts.length > 1 && parts[1].trim() !== "") {
        const dateParts = parts[1].split("/");
        if (dateParts.length === 3) 
            logDate = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
        else 
            logDate = parts[1].replace(/\s/g,"_");
    }

    let csvContent = rows.join("\n");
    let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = `eventosshot_${logDate}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

const title = document.getElementById("title");
const text = title.textContent;
title.textContent = "";

for (let i = 0; i < text.length; i++) {
    const span = document.createElement("span");
    span.textContent = text[i];
    span.style.animationDelay = (Math.random() * 1.5) + "s";
    title.appendChild(span);
}
</script>

</body>
</html>
