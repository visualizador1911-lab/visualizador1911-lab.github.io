<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FORMATEAR TEXTO SHOTSPOTTER POR MAYOR</title>

<style>
html, body, * { cursor: url("./CURSOR.cur"), auto; }

body {
    background-color: #3E1F1F;
    background-image: 
        repeating-linear-gradient(
            45deg,
            #4B2B2B 0px,
            #4B2B2B 40px,
            #6B1F1F 40px,
            #6B1F1F 80px
        ),
        repeating-linear-gradient(
            45deg,
            rgba(255, 255, 255, 0.05) 0,
            rgba(255, 255, 255, 0.05) 40px,
            transparent 40px,
            transparent 80px
        );
    background-size: 80px 80px;
    background-repeat: repeat;
    color: #E0CFCF;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 20px;
}

h2 {
    font-size: 3.5em;
    text-align: center;
    font-weight: bold;
    background: linear-gradient(45deg, #8B0000, #B22222, #FF4C4C);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    -webkit-text-stroke: 2px black;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.3),
                 -1px -1px 1px rgba(0,0,0,0.2);
    animation: pulseEmboss 2s infinite alternate ease-in-out;
}

@keyframes pulseEmboss {
    0% {
        text-shadow: 1px 1px 1px rgba(0,0,0,0.3),
                     -1px -1px 1px rgba(0,0,0,0.2);
        opacity: 0.9;
    }
    50% {
        text-shadow: 2px 2px 2px rgba(0,0,0,0.4),
                     -2px -2px 2px rgba(0,0,0,0.3);
        opacity: 1;
    }
    100% {
        text-shadow: 1px 1px 1px rgba(0,0,0,0.3),
                     -1px -1px 1px rgba(0,0,0,0.2);
        opacity: 0.95;
    }
}

textarea {
    width: calc(100% - 40px);
    max-width: 100%;
    min-width: 300px;
    background: linear-gradient(145deg, #4B2B2B, #6B1F1F);
    color: #F5E5E5;
    border: 2px solid #8B0000;
    padding: 10px;
    font-family: monospace;
    font-size: 14px;
    resize: vertical;
    box-sizing: border-box;
    transition: width 0.3s ease;
}

/* Placeholder bold and larger */
textarea::placeholder {
    font-weight: bold;
    font-size: 21px;
    color: #F5E5E5;
}

button {
    background-color: #8B0000;
    color: #F5E5E5;
    border: none;
    padding: 10px 20px;
    margin: 5px 5px 15px 0;
    font-weight: bold;
    cursor: pointer;
    border-radius: 12px;
    transition: 0.2s;
}

button:hover { background-color: #B22222; }

#counter-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 10px 0;
}

#counter {
    font-size: 1.5em;
    font-weight: bold;
    color: #CD5C5C;
}

#log {
    margin-top: 10px;
    max-height: 400px;
    overflow-y: auto;
    border: 2px solid #8B0000;
    padding: 10px;
    background: linear-gradient(145deg, #4B2B2B, #6B1F1F);
    font-family: monospace;
    white-space: pre;
}

.log-entry { border-bottom: 1px solid #8B0000; padding: 4px; }
.log-content { user-select: text; display: inline-block; }

@keyframes scrambleFade {
    0% { opacity: 0.2; }
    100% { opacity: 1; }
}
.log-entry span {
    animation: scrambleFade 0.3s ease-in-out;
}

#warning {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #A52A2A;
    color: #F5E5E5;
    padding: 12px 18px;
    border-radius: 6px;
    font-weight: bold;
    opacity: 0;
    transition: opacity .4s;
}

#warning.show { opacity: 1; }
</style>
</head>

<body>

<h2>FORMATEAR TEXTO SHOTSPOTTER POR MAYOR</h2>

<textarea id="input" rows="12" placeholder="LUEGO DE REALIZADO EL FILTRO EN SHOTSPOTTER PRESIONAR CTRL+A, CTRL+C Y PEGAR AQUI EL RESULTADO"></textarea><br>

<button onclick="limpiarTodo()">Limpiar</button>
<button onclick="revertLog()">Invertir Orden Cronológico</button>

<div id="counter-container">
    <div id="counter">CANTIDAD DE EVENTOS CARGADOS: 0</div>
    <button onclick="copiarTodo()">Copiar todos los eventos</button>
</div>

<div id="log"></div>
<div id="warning"></div>

<script>
const input = document.getElementById("input");
const log = document.getElementById("log");
const counter = document.getElementById("counter");

input.addEventListener("paste", () => setTimeout(processInput, 0));

function showWarning(msg) {
    const w = document.getElementById("warning");
    w.textContent = msg;
    w.classList.add("show");
    setTimeout(() => w.classList.remove("show"), 2500);
}

function parseDateFromLog(text) {
    const parts = text.split("\t");
    if (!parts[1]) return null;

    const [date, time] = parts[1].split(" ");
    const [d, m, y] = date.split("/").map(Number);
    const [hh, mm, ss] = time.split(":").map(Number);

    return new Date(y, m - 1, d, hh, mm, ss);
}

function autoCheckChronologicalOrder() {
    const entries = [...document.querySelectorAll(".log-entry .log-content")];
    if (entries.length < 2) return;

    const topDate = parseDateFromLog(entries[0].textContent);
    const bottomDate = parseDateFromLog(entries[entries.length - 1].textContent);

    if (topDate && bottomDate && topDate > bottomDate) {
        revertLog();
        showWarning("↕ Orden cronológico corregido automáticamente");
    }
}

function animateTextScramble(element, finalText, speed = 20, callback) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-={}[]<>?";
    let iteration = 0;
    const interval = setInterval(() => {
        let scrambled = "";
        for (let i = 0; i < finalText.length; i++) {
            scrambled += (i < iteration) ? finalText[i] : chars[Math.floor(Math.random() * chars.length)];
        }
        element.textContent = scrambled;
        iteration++;
        if (iteration > finalText.length) {
            clearInterval(interval);
            if (callback) callback();
        }
    }, speed);
}

function processInput() {
    if (!input.value.trim()) return;

    let blocks = input.value.replace(/\r\n/g, "\n").trim().split(/\n\s*\n+/);
    let processed = 0;

    blocks.forEach(block => {
        let lines = block.split("\n").map(l => l.trim()).filter(Boolean);
        if (lines.length < 7) return;

        const firstLine = lines[0];
        let id = lines[1] || "";
        let mainLine = lines[2] || "";
        let cadLine = lines[3] || "";
        let barrio = lines[4] || "";
        let coordLine = lines[6] || "";

        const dtMatch = mainLine.match(/^(\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}:\d{2})/);
        if (!dtMatch) return;

        let dateTime = dtMatch[1];
        const parts = mainLine.split("\t");
        let address = parts[1] || "";
        let zona = parts[2] || "";
        let rounds = parts[3] || "";

        let lat = "", lon = "";
        const coords = coordLine.split("\t");
        if (coords.length === 2) {
            lat = coords[0].replace(",", ".");
            lon = coords[1].replace(",", ".");
        }

        let cad = cadLine.match(/\d+/)?.[0] || "";

        let tipo = "";
        const firstLineNorm = firstLine.trim().toLowerCase();

        if (firstLineNorm === "único-disparo" || firstLineNorm === "single gunshot") {
            tipo = "UNICO-DISPARO";
        } else if (firstLineNorm === "multiple-disparo" || firstLineNorm === "multiple gunshots") {
            tipo = "MULTIPLE-DISPARO";
        } else if (firstLineNorm === "probable-disparo" || firstLineNorm === "probable gunfire") {
            tipo = (rounds === "1") ? "UNICO-DISPARO" : "MULTIPLE-DISPARO";
        } else if (firstLineNorm === "no hay tiroteo" || firstLineNorm === "not gunfire") {
            tipo = "NO HAY TIROTEO";
        }

        if (!id || !dateTime || !lat || !lon) return;

        const result = [
            id,
            dateTime,
            "",
            zona,
            address,
            rounds,
            barrio,
            lat,
            lon,
            "",
            tipo,
            cad
        ].join("\t");

        if ([...document.querySelectorAll(".log-entry .log-content")].some(e => e.textContent === result)) return;

        const entry = document.createElement("div");
        entry.className = "log-entry";
        const span = document.createElement("span");
        span.className = "log-content";
        entry.appendChild(span);
        log.appendChild(entry);

        animateTextScramble(span, result, 10, autoCheckChronologicalOrder);
        processed++;
    });

    input.value = "";
    updateCounter();

    if (processed > 0) showWarning(`✔ ${processed} eventos procesados`);
}

function revertLog() {
    const entries = [...log.querySelectorAll(".log-entry")];
    entries.reverse().forEach(e => log.appendChild(e));
}

function updateCounter() {
    counter.textContent =
        "CANTIDAD DE EVENTOS CARGADOS: " +
        document.querySelectorAll(".log-entry").length;
}

function limpiarTodo() {
    input.value = "";
    log.innerHTML = "";
    updateCounter();
}

function copiarTodo() {
    if (!log.textContent.trim()) {
        showWarning("⚠ No hay eventos para copiar");
        return;
    }

    const text = Array.from(log.querySelectorAll(".log-content"))
                      .map(e => e.textContent)
                      .join("\n");

    navigator.clipboard.writeText(text).then(() => {
        showWarning("✔ Todos los eventos copiados al portapapeles");
    }).catch(() => {
        showWarning("⚠ Error al copiar al portapapeles");
    });
}
</script>

</body>
</html>
